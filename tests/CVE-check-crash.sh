#!/bin/bash
pushd `pwd`
WORK=`pwd`  # aflgo/tests
NAME=binutils
CVE=$1 		# first argv, e.g. 2016-4487
CVE_OUT=$WORK/$NAME/out/$CVE
CVE_FIXED_VERSION=$WORK/$NAME/obj-fixed/$CVE
CVE_OBJ_2=$WORK/$NAME/obj-2/$CVE
TARGET=${CVE_FIXED_VERSION}/binutils/cxxfilt
TARGET_2=${CVE_OBJ_2}/binutils/cxxfilt
CRASH_FILE=$CVE_OUT/target_result/crashes
OUT_ARCHIVE=$WORK/CVE-out/$CVE

rm -rf $CRASH_FILE/README.txt
for i in `ls $CRASH_FILE`
do
	`$TARGET < ${CRASH_FILE}/${i} > /dev/null`
	if [ "$?" = "0" ]
	then 
		cp ${CRASH_FILE}/${i} $OUT_ARCHIVE
		echo "First expose for CVE-${CVE} found. ${i} Fuzzing terminated."
		pid=`pgrep afl-fuzz`
		if [ $pid ]; then kill $pid; fi
		echo "Check the call stack. " 
		echo "valgrind $TARGET_2 < ${CRASH_FILE}/${i}"
		valgrind $TARGET_2 < ${CRASH_FILE}/${i}
		gdb -args $TARGET_2
		break
	fi
done


