#!/bin/bash
pushd `pwd`
WORK=`pwd`  # aflgo/tests
NAME=binutils
CVE=$1 		# first argv, e.g. 2016-4487
CVE_REPRODUCE_FILE=$WORK/CVE-reproduce/$CVE.txt
CVE_TARGET_LINE=$WORK/CVE-target-line/$CVE.txt
CVE_OBJ_DIR=$WORK/$NAME/obj
TARGET=${CVE_OBJ_DIR}/binutils/cxxfilt
CRASH_FILE=$CVE_OUT/target_result/crashes
OUT_ARCHIVE=$WORK/CVE-out/$CVE
LOGGING=$WORK/logging.txt

mangled_name=`cat $CVE_REPRODUCE_FILE` 
echo "----Check the call stack. ----" 
echo "valgrind:"
echo "valgrind $TARGET $mangled_name"
valgrind $TARGET $mangled_name
echo "GDB:"
echo "Backtrace analyzing(500 call stack at most)..."
if [ -e $LOGGING ]; then rm -rf $LOGGING; fi
#gdb -q --batch -x gdbcmd.txt --args $TARGET $mangled_name
gdb -q --batch -x gdbcmd.txt --args $TARGET $mangled_name
if [ ! -e $LOGGING ]
then 
	echo "Logging file generate failed."
else
	echo "----Generating target lines. ----" 
	python3 Generate_target_lines.py $LOGGING $CVE_TARGET_LINE
	echo "Target lines generated."
fi

#echo "manual debug: (press 'q' to quit.)"
#gdb -q -args $TARGET $mangled_name




